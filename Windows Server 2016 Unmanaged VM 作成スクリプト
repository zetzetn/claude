#!/bin/bash

# Windows Server 2016 Unmanaged VM 作成スクリプト (OS/データディスク分離、データディスクアタッチ)
# 最終更新: 2025/07/26 - データディスクサイズを32GBに修正

# 変数設定
RESOURCE_GROUP="rg-unmanaged-test"
LOCATION="japaneast"
VM_NAME="restored-vm01"
OS_STORAGE_ACCOUNT_PREFIX="ososdisk" # OSディスク用ストレージアカウントのプレフィックス
DATA_STORAGE_ACCOUNT_PREFIX="datadisksa" # データディスク用ストレージアカウントのプレフィックス
ADMIN_USERNAME="azureuser"
ADMIN_PASSWORD="YourStrongPassword123!" # !!! 本番環境ではより強力なパスワードを設定してください !!!
VNET_NAME="vnet-unmanaged"
SUBNET_NAME="default"
NSG_NAME="nsg-unmanaged"
NIC_NAME="nic-restored-vm01"
PUBLIC_IP_NAME="pip-restored-vm01"
VM_SIZE="Standard_DS1_v2" # データディスクアタッチのためStandard_DS1_v2を使用

# ユニークなストレージアカウント名生成 (24文字制限対応)
# 日付と時刻のUnixタイムスタンプの末尾6桁を使用
TIMESTAMP_SUFFIX=$(date +%s | tail -c 7) # 末尾6桁+改行文字なので7
OS_STORAGE_ACCOUNT="${OS_STORAGE_ACCOUNT_PREFIX}${TIMESTAMP_SUFFIX}"
DATA_STORAGE_ACCOUNT="${DATA_STORAGE_ACCOUNT_PREFIX}${TIMESTAMP_SUFFIX}"

echo "=== Windows Server 2016 Unmanaged VM 作成開始 ==="
echo "開始時刻: $(date)"

# リソースグループ作成
echo "1. リソースグループ作成中..."
az group create \
  --name $RESOURCE_GROUP \
  --location $LOCATION

# OSディスク用ストレージアカウント作成 (ストレージアカウントA)
echo "2. OSディスク用ストレージアカウント '$OS_STORAGE_ACCOUNT' 作成中..."
az storage account create \
  --resource-group $RESOURCE_GROUP \
  --name $OS_STORAGE_ACCOUNT \
  --location $LOCATION \
  --sku Standard_LRS \
  --kind StorageV2 \
  --tags Usage="OS Disk"

# データディスク用ストレージアカウント作成 (ストレージアカウントB)
echo "3. データディスク用ストレージアカウント '$DATA_STORAGE_ACCOUNT' 作成中..."
az storage account create \
  --resource-group $RESOURCE_GROUP \
  --name $DATA_STORAGE_ACCOUNT \
  --location $LOCATION \
  --sku Standard_LRS \
  --kind StorageV2 \
  --tags Usage="Data Disk"

# ネットワーク作成 (既存のスクリプトとほぼ同じ)
echo "4. ネットワーク設定中..."
az network vnet create \
  --resource-group $RESOURCE_GROUP \
  --name $VNET_NAME \
  --address-prefix 10.0.0.0/16 \
  --subnet-name $SUBNET_NAME \
  --subnet-prefix 10.0.0.0/24

az network nsg create \
  --resource-group $RESOURCE_GROUP \
  --name $NSG_NAME

az network nsg rule create \
  --resource-group $RESOURCE_GROUP \
  --nsg-name $NSG_NAME \
  --name AllowRDP \
  --protocol tcp \
  --priority 1000 \
  --destination-port-range 3389 \
  --access allow

az network public-ip create \
  --resource-group $RESOURCE_GROUP \
  --name $PUBLIC_IP_NAME \
  --allocation-method static

az network nic create \
  --resource-group $RESOURCE_GROUP \
  --name $NIC_NAME \
  --vnet-name $VNET_NAME \
  --subnet $SUBNET_NAME \
  --public-ip-address $PUBLIC_IP_NAME \
  --network-security-group $NSG_NAME

# VM作成 (OSディスクをストレージアカウントAに作成)
echo "5. VM作成中 (OSディスクは'$OS_STORAGE_ACCOUNT'へ)..."
az vm create \
  --resource-group $RESOURCE_GROUP \
  --name $VM_NAME \
  --image MicrosoftWindowsServer:WindowsServer:2016-Datacenter:14393.7973.250409 \
  --size $VM_SIZE \
  --storage-account $OS_STORAGE_ACCOUNT \
  --use-unmanaged-disk \
  --admin-username $ADMIN_USERNAME \
  --admin-password $ADMIN_PASSWORD \
  --location $LOCATION \
  --nics $NIC_NAME

# データディスクの作成とアタッチ (ストレージアカウントBに作成、Eドライブとして)
# データディスク名
DATA_DISK_NAME="${VM_NAME}-data-disk-01"
DATA_DISK_SIZE_GB=32 # ★ここを32GBに変更しました★

echo "6. データディスク '$DATA_DISK_NAME' (Unmanaged) を作成し、VMにアタッチ中 (ストレージアカウントB: '$DATA_STORAGE_ACCOUNT')..."
az vm disk attach \
  --resource-group $RESOURCE_GROUP \
  --vm-name $VM_NAME \
  --name $DATA_DISK_NAME \
  --sku Standard_LRS \
  --size-gb $DATA_DISK_SIZE_GB \
  --new \
  --lun 0 \
  --caching ReadWrite \
  --storage-account $DATA_STORAGE_ACCOUNT \
  --attach-os-disk false \
  --use-unmanaged-disk

# 結果確認
echo "7. 作成結果確認中..."
PUBLIC_IP=$(az network public-ip show \
  --resource-group $RESOURCE_GROUP \
  --name $PUBLIC_IP_NAME \
  --query ipAddress -o tsv)

echo ""
echo "=== 作成完了 ==="
echo "完了時刻: $(date)"
echo ""
echo "=== 接続情報 ==="
echo "VM名: $VM_NAME"
echo "パブリックIP: $PUBLIC_IP"
echo "ユーザー名: $ADMIN_USERNAME"
echo "パスワード: $ADMIN_PASSWORD"
echo "OSディスク用ストレージアカウント: $OS_STORAGE_ACCOUNT"
echo "データディスク用ストレージアカウント: $DATA_STORAGE_ACCOUNT"
echo ""

# VM詳細表示
az vm show \
  --resource-group $RESOURCE_GROUP \
  --name $VM_NAME \
  --show-details \
  --query "{Name:name, PowerState:powerState, PublicIP:publicIps, PrivateIP:privateIps, VMSize:hardwareProfile.vmSize, OsDisk:storageProfile.osDisk.managedDisk.id, DataDisks:storageProfile.dataDisks}" \
  --output json # データディスク情報を見やすくするためJSON出力

# VHDファイル確認 (OSディスク用ストレージアカウント)
echo ""
echo "=== OSディスク用VHDファイル確認 ($OS_STORAGE_ACCOUNT) ==="
OS_STORAGE_KEY=$(az storage account keys list \
  --resource-group $RESOURCE_GROUP \
  --account-name $OS_STORAGE_ACCOUNT \
  --query "[0].value" -o tsv)

az storage blob list \
  --account-name $OS_STORAGE_ACCOUNT \
  --container-name vhds \
  --account-key $OS_STORAGE_KEY \
  --query "[].{Name:name, Size:properties.contentLength, LastModified:properties.lastModified}" \
  --output table

# VHDファイル確認 (データディスク用ストレージアカウント)
echo ""
echo "=== データディスク用VHDファイル確認 ($DATA_STORAGE_ACCOUNT) ==="
DATA_STORAGE_KEY=$(az storage account keys list \
  --resource-group $RESOURCE_GROUP \
  --account-name $DATA_STORAGE_ACCOUNT \
  --query "[0].value" -o tsv)

az storage blob list \
  --account-name $DATA_STORAGE_ACCOUNT \
  --container-name vhds \
  --account-key $DATA_STORAGE_KEY \
  --query "[].{Name:name, Size:properties.contentLength, LastModified:properties.lastModified}" \
  --output table

# ========================================
# 現在のパラメータ表
# ========================================

echo ""
echo "=== 設定パラメータ一覧 ==="
cat << EOF
+------------------------+----------------------------------------+
| パラメータ              | 値                                     |
+------------------------+----------------------------------------+
| リソースグループ        | rg-unmanaged-test                      |
| ロケーション            | japaneast                              |
| VM名                   | restored-vm01                          |
| OSイメージ             | Windows Server 2016 Datacenter        |
| イメージバージョン      | 14393.7973.250409                      |
| VMサイズ               | Standard_DS1_v2                        |
| ディスクタイプ          | Unmanaged (VHD)                        |
| OSディスクSA           | ososdisk[timestamp]                    |
| データディスクSA        | datadisksa[timestamp]                  |
| データディスク容量      | 32 GB                                   |
| ストレージSKU          | Standard_LRS                           |
| 管理者ユーザー名        | azureuser                              |
| 管理者パスワード        | YourStrongPassword123!                 |
| 仮想ネットワーク        | vnet-unmanaged (10.0.0.0/16)          |
| サブネット             | default (10.0.0.0/24)                 |
| セキュリティグループ    | nsg-unmanaged                          |
| ネットワークIF         | nic-restored-vm01                      |
| パブリックIP           | pip-restored-vm01 (Static)             |
| 許可ポート             | 3389 (RDP)                             |
+------------------------+----------------------------------------+
EOF
