#!/usr/bin/env pwsh

# Windows Server 2016 Unmanaged VM 作成スクリプト (OS/データディスク分離、データディスクアタッチ) - 統合版
# 最終更新: 2025/07/26

# --- 0. Azure アカウントへのログイン (Cloud Shell の場合、通常は不要) ---
# Connect-AzAccount -UseDeviceAuthentication

# 複数のサブスクリプションがある場合は、適切なサブスクリプションを選択 (必要に応じてコメント解除)
# Get-AzSubscription
# Select-AzSubscription -SubscriptionName "あなたのサブスクリプション名"

# スクリプトの出力をログファイルに記録開始
$logFilePath = "/home/$env:USER/vm_creation_full_log_$(Get-Date -Format 'yyyyMMdd_HHmmss').txt"
Write-Host "スクリプトの出力をログファイルに記録します: $logFilePath"
Start-Transcript -Path $logFilePath -Append -Force

Write-Host "=== Windows Server 2016 Unmanaged VM 作成開始 (統合スクリプト) ==="
Write-Host "開始時刻: $(Get-Date)"

# --- 1. 変数定義 ---
Write-Host "`n--- ステップ 1: 変数定義 ---"
$RESOURCE_GROUP="rg-unmanaged-test" # 既存のリソースグループを想定
$LOCATION="japaneast"
$VM_NAME="restored-vm01"
$OS_STORAGE_ACCOUNT_PREFIX="ososdisk" # OSディスク用ストレージアカウントのプレフィックス
$DATA_STORAGE_ACCOUNT_PREFIX="datadisksa" # データディスク用ストレージアカウントのプレフィックス
$ADMIN_USERNAME="azureuser"
$ADMIN_PASSWORD="YourStrongPassword123!" # !!! 本番環境ではより強力なパスワードを設定してください !!!
$VNET_NAME="vnet-unmanaged"
$SUBNET_NAME="default"
$NSG_NAME="nsg-unmanaged"
$NIC_NAME="nic-restored-vm01"
$PUBLIC_IP_NAME="pip-restored-vm01"
$VM_SIZE="Standard_DS1_v2" # データディスクアタッチのためStandard_DS1_v2を使用
$DATA_DISK_SIZE_GB=32 # データディスクのサイズ (GB)
$DATA_DISK_NAME="${VM_NAME}-data-disk-01"

# ユニークなストレージアカウント名生成 (24文字制限対応)
$TIMESTAMP_SUFFIX=$(Get-Date -UFormat %s | Select-Object -Last 6)
$OS_STORAGE_ACCOUNT="${OS_STORAGE_ACCOUNT_PREFIX}${TIMESTAMP_SUFFIX}"
$DATA_STORAGE_ACCOUNT="${DATA_STORAGE_ACCOUNT_PREFIX}${TIMESTAMP_SUFFIX}"
Write-Host "変数定義が完了しました。"

# --- 2. ストレージアカウント作成 ---
Write-Host "`n--- ステップ 2: ストレージアカウント作成 ---"
# OSディスク用ストレージアカウント作成 (ストレージアカウントA)
Write-Host "OSディスク用ストレージアカウント '$OS_STORAGE_ACCOUNT' 作成中..."
try {
    az storage account create `
      --resource-group $RESOURCE_GROUP `
      --name $OS_STORAGE_ACCOUNT `
      --location $LOCATION `
      --sku Standard_LRS `
      --kind StorageV2 `
      --tags Usage="OS Disk" -ErrorAction Stop
    Write-Host "OSディスク用ストレージアカウント '$OS_STORAGE_ACCOUNT' が正常に作成されました。"
} catch {
    Write-Error "OSディスク用ストレージアカウントの作成中にエラーが発生しました: $($_.Exception.Message)"
    Stop-Transcript
    exit 1
}

# データディスク用ストレージアカウント作成 (ストレージアカウントB)
Write-Host "データディスク用ストレージアカウント '$DATA_STORAGE_ACCOUNT' 作成中..."
try {
    az storage account create `
      --resource-group $RESOURCE_GROUP `
      --name $DATA_STORAGE_ACCOUNT `
      --location $LOCATION `
      --sku Standard_LRS `
      --kind StorageV2 `
      --tags Usage="Data Disk" -ErrorAction Stop
    Write-Host "データディスク用ストレージアカウント '$DATA_STORAGE_ACCOUNT' が正常に作成されました。"
} catch {
    Write-Error "データディスク用ストレージアカウントの作成中にエラーが発生しました: $($_.Exception.Message)"
    Stop-Transcript
    exit 1
}
Write-Host "ストレージアカウント作成完了。"

# --- 3. ネットワークリソース作成 ---
Write-Host "`n--- ステップ 3: ネットワークリソース作成 ---"
# 仮想ネットワーク作成
Write-Host "仮想
